<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CKART Admin Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; background: #f4f7f6; }
        .sidebar { width: 250px; background: #2c3e50; color: white; height: 100vh; position: fixed; }
        .sidebar h2 { text-align: center; color: gold; padding: 20px 0; border-bottom: 1px solid #34495e; }
        .menu-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #34495e; transition: 0.3s; }
        .menu-item:hover { background: #34495e; color: gold; }
        .main-content { margin-left: 250px; padding: 30px; width: calc(100% - 250px); }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: none; }
        .active { display: block; }
        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .input-group { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 5px; font-size: 14px; color: #555; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 6px; outline: none; }
        input:focus { border-color: #27ae60; }
        .btn-save { grid-column: span 2; padding: 15px; background: #27ae60; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.3s; }
        .btn-save:hover { background: #219150; }
        #status { margin-top: 15px; font-weight: bold; text-align: center; padding: 10px; border-radius: 5px; }
        .camera-link { font-size: 24px; text-decoration: none; display: flex; align-items: center; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>CKART ADMIN</h2>
        <div class="menu-item" onclick="showPage('add-product')">‚ûï Add Product</div>
        <div class="menu-item" onclick="showPage('edit-product')">‚úèÔ∏è Edit Product</div>
        <div class="menu-item" onclick="showPage('order-status')">üì¶ Orders</div>
    </div>

    <div class="main-content">
        <div id="add-product" class="card active">
            <h3>Add New Product (Indian Rupee ‚Çπ)</h3>
            <div class="grid-form">
                <div class="input-group" style="grid-column: span 2;">
                    <label>GitHub Access Token:</label>
                    <input type="password" id="gh-token" placeholder="Enter PAT Token">
                </div>
                
                <div class="input-group">
                    <label>Category:</label>
                    <div style="display:flex; gap:5px;">
                        <select id="p-cat">
                            <option value="body_care.json">Body Care</option>
                            <option value="face_care.json">Face Care</option>
                            <option value="baby_care.json">Baby Care</option>
                            <option value="cosmetic.json">Cosmetic</option>
                            <option value="gold_jewelry.json">Gold Jewelry</option>
                            <option value="hair_care.json">Hair Care</option>
                            <option value="personal_care.json">Personal Care</option>
                            <option value="others.json">Others</option>
                        </select>
                        <button type="button" onclick="addNewCat()" style="cursor:pointer; padding:0 10px;">+</button>
                    </div>
                </div>

                <div class="input-group"><label>Product Code:</label><input type="text" id="p-code" placeholder="e.g., CK-101"></div>
                <div class="input-group"><label>Product Name:</label><input type="text" id="p-name" placeholder="Full Product Name"></div>
                <div class="input-group">
                    <label>Unit / Quantity:</label>
                    <select id="p-unit">
                        <option>ml</option><option>g</option><option>pcs</option><option>Combo</option>
                    </select>
                </div>
                <div class="input-group"><label>MRP (‚Çπ):</label><input type="number" id="p-mrp" placeholder="0.00"></div>
                <div class="input-group"><label>Discount (%):</label><input type="number" id="p-disc" value="0"></div>
                <div class="input-group"><label>Stock Quantity:</label><input type="number" id="p-stock" placeholder="e.g., 50"></div>
                <div class="input-group">
                    <label>Image Direct Link (ImgBB):</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="p-img" placeholder="https://i.ibb.co/direct-link.jpg" style="flex-grow:1;">
                        <a href="https://sarifuddin-monda.imgbb.com/" target="_blank" class="camera-link">üì∑</a>
                    </div>
                </div>

                <button class="btn-save" id="save-btn" onclick="saveToGithub()">Save Product & Ready Next</button>
            </div>
            <div id="status"></div>
        </div>

        <div id="edit-product" class="card"><h3>Edit Product</h3><p>Select a category to view products.</p></div>
        <div id="order-status" class="card"><h3>Consumer Orders</h3><div id="order-list">No orders yet.</div></div>
    </div>

    <script>
        const USER = "sarifuddinmondal";
        const REPO = "ckart-project";

        function showPage(id) {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function addNewCat() {
            let n = prompt("New Category Name:");
            if(n) {
                let s = document.getElementById('p-cat');
                let opt = document.createElement("option");
                opt.text = n; 
                opt.value = n.toLowerCase().replace(/\s+/g, '_') + ".json";
                s.add(opt);
            }
        }

        async function saveToGithub() {
            const token = document.getElementById('gh-token').value;
            const fileName = document.getElementById('p-cat').value;
            const status = document.getElementById('status');
            const saveBtn = document.getElementById('save-btn');

            if(!token) { alert("GitHub Token is required!"); return; }

            // Visual feedback
            saveBtn.disabled = true;
            saveBtn.innerText = "Uploading... Please wait";
            status.innerText = "Connecting to GitHub API...";
            status.style.background = "#e3f2fd";
            status.style.color = "#0d47a1";

            const url = `https://api.github.com/repos/${USER}/${REPO}/contents/${fileName}`;

            try {
                let sha = "";
                let content = [];
                
                // 1. Fetch existing file data
                const res = await fetch(url, { 
                    headers: { 'Authorization': `token ${token}`, 'Cache-Control': 'no-cache' } 
                });
                
                if(res.ok) {
                    const data = await res.json();
                    sha = data.sha;
                    content = JSON.parse(atob(data.content));
                }

                // 2. Prepare new product object
                const newProduct = {
                    code: document.getElementById('p-code').value,
                    name: document.getElementById('p-name').value,
                    unit: document.getElementById('p-unit').value,
                    mrp: parseFloat(document.getElementById('p-mrp').value) || 0,
                    discount: parseFloat(document.getElementById('p-disc').value) || 0,
                    stock: parseInt(document.getElementById('p-stock').value) || 0,
                    img: document.getElementById('p-img').value,
                    id: Date.now()
                };

                content.push(newProduct);

                // 3. Push back to GitHub
                const updateRes = await fetch(url, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `token ${token}`, 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({
                        message: `Added product: ${newProduct.name}`,
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))),
                        sha: sha || undefined
                    })
                });

                if(updateRes.ok) {
                    status.innerText = "SUCCESS: Product saved! Ready for the next one.";
                    status.style.background = "#e8f5e9";
                    status.style.color = "#2e7d32";
                    
                    // Clear only product details, keep token and category
                    document.getElementById('p-code').value = "";
                    document.getElementById('p-name').value = "";
                    document.getElementById('p-mrp').value = "";
                    document.getElementById('p-disc').value = "0";
                    document.getElementById('p-stock').value = "";
                    document.getElementById('p-img').value = "";
                    
                    // Put focus back on first field
                    document.getElementById('p-code').focus();
                } else {
                    throw new Error("Failed to upload. Check token permissions.");
                }
            } catch (e) {
                status.innerText = "ERROR: " + e.message;
                status.style.background = "#ffebee";
                status.style.color = "#c62828";
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerText = "Save Product & Ready Next";
            }
        }
    </script>
</body>
</html>
